<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dua Educational Portal â€” Complete (Payments Demo)</title>
  <style>
    :root{
      --bg: linear-gradient(135deg,#16d2e7,#06434b);
      --card:#f7f8f9;
      --accent:#4f05fd;
      --accent2:#f404a0;
      --accent3:#f5f4f67e;
      --muted:#1368df35;
      --radius:10px;
      --max:auto;
      --shadow: 0 8px 20px rgba(50, 109, 247, 0.08);
      font-family: Inter, system-ui, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:#011a2a}
    .wrap{max-width:1200px;margin:10px auto;padding:12px}
    header{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:8px;border-radius:6px;box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:15px}
    .brand img{width:36px;height:36px;border-radius:8px;object-fit:cover}
    .brand h1{font-size:18px;margin:0;color:#fff}
    nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    nav a{color:#f5f5f3;text-decoration:none;padding:6px 8px;border-radius:8px;cursor:pointer;font-weight:600}
    .layout{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px}
    .card{background:var(--card);padding:18px;border-radius:10px;box-shadow:var(--shadow)}
    h2{margin:0 0 10px 0;color:var(--accent)}
    label{display:block;font-weight:500;margin-bottom:6px;color:#334155}
    input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(6,40,61,0.06);margin-bottom:5px;font-size:12px}
    input:focus,select:focus,textarea:focus{outline:2px solid rgba(79,70,229,0.12);border-color:rgba(79,70,229,0.2)}
    .btn-row{display:flex;gap:8px}
    .btn{cursor:pointer;border:none;padding:10px 12px;border-radius:8px;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
    .btn-ghost{background:transparent;border:2px solid var(--accent);color:var(--accent)}
    .small{font-size:11px;color:#64748b}
    .result-row{padding:10px;border-radius:8px;background:#f8fafc;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th,.table td{border:1px solid #e6eef6;padding:8px;background:white;text-align:left}
    .table th{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
    .hidden{display:none}
    .stu-photo{width:96px;height:96px;border-radius:8px;object-fit:cover;border:2px solid rgba(0,0,0,0.04)}
    .confirm-box{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg,#ecfeff,#f0f9ff);border:1px solid rgba(6,40,61,0.04)}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .admin-img { width:60px;height:60px;border-radius:6px;object-fit:cover;border:1px solid #ddd }
    .toast { position: fixed; right: 20px; bottom: 20px; background: #0f766e; color: white; padding: 12px 16px; border-radius: 8px; box-shadow: 0 6px 18px rgba(215, 36, 36, 0.12); z-index: 9999; display:none; }
    .teachers-container{ display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:25px; }
    .teacher-card{ width: calc((100% - 40px) / 3); max-width: 200px; text-align: center; background: #fff; border-radius: 12px; padding: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .teacher-card img{ width: 160px; height:160px; object-fit:cover; border-radius:50%; display:block; margin:auto; }
    .teacher-name{ font-weight:bold; font-size:1rem; color:var(--accent) }
    .teacher-subject{ font-size:0.9rem; color:var(--muted) }
    .teacher-gallery{ display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px }
    .teacher-gallery img{ width:220px;height:210px;object-fit:cover;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.06) }
    @media (max-width:640px){ .teacher-card{ width: calc(50% - 10px); max-width: 45vw; } .teacher-card img{ width:120px;height:120px; } }
    .slip-wrapper{ border:3px solid #0077ff; padding:25px; border-radius:12px; background:white; }
    .slip-header{text-align:center;margin-bottom:18px}
    .academy-logo{width:40px}
    .academy-title{font-size:24px;font-weight:800;color:#00306e}
    .slip-box{display:flex;gap:20px;background:#eaf3ff;padding:20px;border-radius:12px}
    .left-photo{width:140px}
    .stu-photo{width:140px;height:160px;object-fit:cover;border:2px solid #00306e;border-radius:10px}
    .data{ flex:1; }
    .slip-heading{font-size:20px;margin-bottom:10px;color:#00306e;font-weight:700}
    .field{margin:4px 0;font-size:15px}
    .small-heading{margin-top:10px;font-size:16px;color:#00306e;font-weight:600}
    .roll-style{font-size:18px;padding:3px 10px;color:white;background:#0077ff;border-radius:8px;font-weight:700}
    .sign-row{margin-top:25px;display:flex;justify-content:space-between;padding:0 20px}
    .sign-img{width:140px;opacity:0.9}
    .stamp-img{width:120px;opacity:0.9}
    .sign-text{text-align:center;font-size:14px;margin-top:5px;font-weight:600}
    @media print{ body{ background:white; } .slip-wrapper{ box-shadow:none; } }
    .small-card { width: 220px; background: #f9f6f7; border-radius: 14px; overflow: hidden; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin: 12px; font-family: sans-serif; }
    .small-card .card-header { background: #2404f4; color: #f7f6f6; padding: 10px; font-size: 18px; font-weight: 800; }
    .small-card .name { font-weight: 800; margin-top: 10px; color: #333; }
    .call-btn { background: #28a745; color:rgb(246, 242, 242); text-decoration:none; display:inline-block; padding:8px 12px; border-radius:25px; }
    .wa-btn { background: #25D366; color:white; text-decoration:none; display:inline-block; padding:8px 12px; border-radius:25px; }
    /* Modal styles */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,0.6); display:none; align-items:center; justify-content:center; z-index:9998; }
    .modal{ width:420px; max-width:95%; background:white; border-radius:12px; padding:18px; box-shadow:0 10px 30px rgba(2,6,23,0.3) }
    .modal h3{ margin-top:0 }
    .demo-steps{ display:flex; gap:8px; margin-top:12px }
    .badge{ display:inline-block; padding:6px 8px; border-radius:8px; background:#eef2ff; color:#4338ca; font-weight:700 }

    


  </style>

  
</head>
<body>
<div class="wrap">

  <header>
    <div class="brand">
      <img id="siteLogo" src="logo dua Academy kamoon shaheed.PNG" alt="Logo" onerror="this.style.display='none'">
      <div>
        <h1>DUA</h1>
        <div class="small" style="color:rgba(255,255,255,0.9)"></div>
      </div>
    </div>
    <nav>
      <a onclick="openSection('home')">Home</a>
      <a onclick="openSection('apply')">Apply</a>
      <a onclick="openSection('slip')">Slip</a>
      <a onclick="openSection('result')">Result</a>
      <a onclick="openSection('admin')"></a>
      <a onclick="openSection('marksUpload')"></a>
    </nav>
  </header>

  <main class="layout">
    <section id="home" class="card home-card">
      <div style="text-align:center; padding:10px;">
        <img src="logo dua Academy kamoon shaheed.PNG" width="220" height="220" style="border-radius:10px;" alt="Academy Logo" onerror="this.style.display='none'">
        <h2 style="font-size:22px; text-align:center; margin-bottom:10px;">Welcome to Dua Educational Academy Kamoon Shaheed</h2>
        <p class="home-desc" style="text-align:center; font-size:14px;">Official Online Portal â€” Auto Roll â€¢ Apply â€¢ Slip â€¢ Result â€¢ Admin</p>
      </div>

      <div style="display:flex;justify-content:center;gap:8px;margin-top:8px;">
        <button class="btn btn-primary" onclick="openSection('apply')" style="width:auto;">Apply</button>
        <button class="btn btn-primary" onclick="openSection('slip')" style="width:auto;">Slip</button>
        <button class="btn btn-primary" onclick="openSection('result')" style="width:auto;">Result</button>
        <button class="btn btn-primary" onclick="openSection('admin')" style="width:auto;">Admin</button>
        <button class="btn btn-primary" onclick="openSection('marksUpload')" style="width:auto;">My portal</button>
      </div>

      <div style="display:flex;flex-wrap:wrap;justify-content:center;margin-top:12px">
        <div class="small-card">
          <div class="card-header">Director</div>
          <img src="p.jpg" alt="" style="width:120px;height:120px;border-radius:50%;margin-top:12px" onerror="this.style.display='none'">
          <div class="name">Noor Muhammad Musafir Soomro</div>
          <div style="margin:8px 0"><a class="call-btn" href="tel:03083442741">ðŸ“ž Call</a></div>
        </div>
        <div class="small-card">
          <div class="card-header">Pattern</div>
          <img src="Sir gada hussain.jpg" alt="" style="width:120px;height:120px;border-radius:50%;margin-top:12px" onerror="this.style.display='none'">
          <div class="name">Gada Hussain Soomro</div>
          <div style="margin:8px 0"><a class="call-btn" href="tel:03083442741">ðŸ“ž Call</a> <a class="wa-btn" href="https://wa.me/923083442741">WhatsApp</a></div>
        </div>
        <div class="small-card">
          <div class="card-header">Teacher</div>
          <img src="sir Ahmed.jpg" alt="" style="width:120px;height:120px;border-radius:50%;margin-top:12px" onerror="this.style.display='none'">
          <div class="name">Ahmed Ali Chachar</div>
          <div style="margin:8px 0"><a class="call-btn" href="tel:03002627384">ðŸ“ž Call</a> <a class="wa-btn" href="https://wa.me/923002627384">WhatsApp</a></div>
        </div>
        
        <div class="small-card">
          <div class="card-header">Web Dev</div>
          <img src="ubedulla khan.PNG" alt="" style="width:120px;height:120px;border-radius:50%;margin-top:12px" onerror="this.style.display='none'">
          <div class="name">Ubedullah Khan</div>
          <div style="margin:8px 0"><a class="call-btn" href="tel:03013402708">ðŸ“ž Call</a> <a class="wa-btn" href="https://wa.me/923013402708">WhatsApp</a></div>

        </div>
      </div>

      <div class="teacher-gallery" aria-hidden="false">
        <img src="sir gada.PNG" alt="Sir Gada" onerror="this.style.display='none'">
        <img src="p6.jpg" alt="Ahmed" onerror="this.style.display='none'">
        <img src="p5.jpg" alt="Ubedullah Khan" onerror="this.style.display='none'">
        <img src="p4.jpg" alt="Sir Niaz" onerror="this.style.display='none'">
        <img src="p15.jpg" alt="Ubedullah Khan" onerror="this.style.display='none'">
        <img src="p10.jpg" alt="Sir Niaz" onerror="this.style.display='none'">
        <img src="p14.jpg" alt="Ubedullah Khan" onerror="this.style.display='none'">
        <img src="p11.jpg" alt="Sir Niaz" onerror="this.style.display='none'">
        <img src="p12.jpg" alt="Ubedullah Khan" onerror="this.style.display='none'">
        <img src="p13.jpg" alt="Sir Niaz" onerror="this.style.display='none'">
        </div>
      </div>
    </section>

    <!-- Apply -->
    <section id="apply" class="card hidden">
      <div style="padding:6px;background:#f5f7f8;border-radius:10px;text-align:center">
        <h3>Dua Educational Academy Kamoon Shaheed</h3>
        <h2>Online Apply Form</h2>

        <form id="applyForm" autocomplete="off">
          <h4 class="small" style="color:var(--accent)">Student Information</h4>
          <label> Name <input id="stu_name" required /></label>
          <label> Surname <input id="stu_surname" required /></label>

          <label> Gender
            <select id="stu_gender" required>
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </label>

          <label> Date of Birth <input id="stu_dob" type="date" required /></label>
          <label> CNIC (13 digits) <input id="stu_cnic" maxlength="13" inputmode="numeric" pattern="[0-9]*" required /></label>

          <label> Class
            <select id="stu_class" required onchange="calcAppFee()">
              <option value="">Select Class</option>
              <option value="5">5</option><option value="6">6</option><option value="7">7</option>
              <option value="8">8</option><option value="9">9</option><option value="10">10</option>
              <option value="11-Medical">11 - Medical</option><option value="11-Eng">11 - Eng</option>
              <option value="12-Medical">12 - Medical</option><option value="12-Eng">12 - Eng</option>
            </select>
          </label>

          <label> Past School Name <input id="stu_pastSchool" /></label>
          <label> WhatsApp Number (11 digits) <input id="stu_whatsapp" maxlength="11" inputmode="numeric" pattern="[0-9]*" /></label>
          <label> Upload Photo (optional) <input id="stu_photo" type="file" accept="image/*" /></label>

          

          <h4 class="small" style="color:var(--accent)">Father Information</h4>
          <label> Father Name <input id="father_name" required /></label>
          <label> Father Surname <input id="father_surname" required /></label>
          <label> Father CNIC (13 digits) <input id="father_cnic" maxlength="13" inputmode="numeric" pattern="[0-9]*" required /></label>
          <label> Occupation <input id="father_occupation" /></label>

          <h4 class="small" style="color:var(--accent)">Payment</h4>
          <label> Application Fee  <input id="app_fee" readonly /> </label>
          <label class="small">You can either Simulate JazzCash (auto-verify) OR Upload a payment screenshot</label>
          <label> Upload Payment Screenshot (optional) <input id="fee_screenshot" type="file" accept="image/*" /></label>

          <label> Payment Sent From Number (03083842741) <h2>GADA HUSSAIN SOOMRO JazzCash</h2> <input id="payment_sender_number" maxlength="11" inputmode="numeric" placeholder="FROM NUMBER " /></label>
          <div class="btn-row">
            <button class="btn btn-primary" type="submit">Submit Application & Pay</button>
            <button type="button" class="btn btn-ghost" onclick="applyFormReset()">Reset</button>
          </div>
        </form>
        

        <div id="applyConfirm" class="hidden" style="margin-top:14px"></div>

        <h4 style="margin-top:14px">Saved Applications</h4>
        <div id="appsList" class="small">No applications yet.</div>
      </div>
    </section>
    

    <!-- Slip -->
    <section id="slip" class="card hidden">
      <div style="padding:12px;background:#f0f9ff;border-radius:10px;text-align:center">
        <img src="logo dua Academy kamoon shaheed.PNG" class="stu-photo" alt="Logo" onerror="this.style.display='none'">
        <h2>Admit Slip</h2>
        <label> Enter Roll Number <input id="slip_roll" /></label>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" id="genSlipBtn">Generate Slip</button>
          <button class="btn btn-ghost" id="printSlipBtn">Print / Save PDF</button>
        </div>
        <div id="slipArea" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Result -->
    <section id="result" class="card hidden">
      <div style="padding:8px;background:#f6f7f8;border-radius:6px;text-align:center">
        <img src="logo dua Academy kamoon shaheed.PNG" width="200" height="180" alt="Logo" onerror="this.style.display='none'">
        <h2>Result</h2>
        <label> Enter Roll Number <input id="res_roll" /></label>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" id="checkResBtn">Check Result</button>
          <button class="btn btn-ghost" id="printResultBtn">Print / Save PDF</button>
        </div>
        <div id="resultArea" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card hidden">
      <div style="padding:12px;background:#f0f9ff;border-radius:10px;text-align:center">
        <img src="logo dua Academy kamoon shaheed.PNG" width="200" height="200" alt="Logo" onerror="this.style.display='none'">
        <h2>Admin Panel</h2>

        <form id="adminLoginForm">
          <label> Password <input id="adminPass" type="password" required /></label>
          <div style="display:flex;gap:8px"><button class="btn btn-primary" type="submit">Login</button></div>
        </form>

        <div id="adminArea" class="hidden" style="margin-top:12px">
          <h4>Applications & Marks (editable)</h4>
          <table class="table" id="adminTable">
            <thead>
              <tr>
                <th>Roll</th><th>Photo</th><th>Name</th><th>Surname</th><th>Gender</th><th>DOB</th><th>CNIC</th>
                <th>Class</th><th>Past School</th><th>WhatsApp</th><th>Father Name</th><th>Father Surname</th>
                <th>Father CNIC</th><th>Father Occupation</th><th>Fee</th><th>Payment From</th><th>Payment</th><th>Marks</th><th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Marks Upload -->
    <section id="marksUpload" class="card hidden">
      <div style="padding:12px;background:#f0f9ff;border-radius:10px;text-align:center">
        <img src="logo dua Academy kamoon shaheed.PNG" width="200" height="200" alt="Logo" onerror="this.style.display='none'">
        <h2>Upload Marks (Single entry test)</h2>
        <form id="marksForm">
          <label>Password <input id="marksPass" type="password" required /></label>
          <div style="display:flex;gap:8px"><button class="btn btn-primary" type="submit">Open</button></div>
        </form>

        <div id="marksArea" class="hidden" style="margin-top:12px">
          <label> Roll Number <input id="marks_roll" /></label>
          <label> Marks (0-100) <input id="marks_value" type="number" min="0" max="100" /></label>
          <div style="display:flex;gap:8px"><button id="saveMarksBtn" class="btn btn-primary">Upload Marks</button>
          <button class="btn btn-ghost" onclick="openSection('admin')">Go to Admin</button></div>
        </div>
      </div>
    </section>

  </main>

  <footer style="text-align:center;margin-top:18px" class="small">Â© Dua Educational Academy Kamoon Shaheed Portal </footer>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Modal for Demo Payment -->
<div id="paymentModal" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Payment </h3>
    <p>This is a demo payment modal. Choose one of the options below:</p>

    <div class="demo-steps">
      <button id="simPayBtn" class="btn btn-primary">Simulate JazzCash (Auto-verify)</button>
      <button id="uploadOnlyBtn" class="btn btn-ghost">Upload Screenshot (Manual verify)</button>
    </div>

    <hr/>
    <div style="font-size:13px" class="small">
      <div><strong>Note:</strong> In REAL integration you'll replace client-side simulation with server-side JazzCash API calls and verification using Merchant ID, Password and Integrity Salt.</div>
      <div style="margin-top:6px"><span class="badge">Tip</span> After simulation, application will be saved with <strong>Approved</strong> payment.</div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="closeModalBtn" class="btn">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ------------------ CONFIG ------------------ */
// Admin password (change if needed)
const ADMIN_PASSWORD = 'uk6091';
const ACADEMY_NAME = 'Dua Educational Academy';

// Placeholder variables (for future REAL integration; do NOT store real secrets client-side)
// When you implement real JazzCash, move these to server config and never expose here.
const JAZZCASH_PLACEHOLDER = {
  merchantId: 'REPLACE_WITH_MERCHANT_ID',
  password: 'REPLACE_WITH_PASSWORD',
  integritySalt: 'REPLACE_WITH_SALT',
  returnUrl: 'https://yourdomain.com/payment-callback'
};

/* ------------------ STORAGE HELPERS ------------------ */
function q(id){ return document.getElementById(id); }
function readApps(){ try{ return JSON.parse(localStorage.getItem('apps')||'[]'); }catch(e){ return []; } }
function readMarks(){ try{ return JSON.parse(localStorage.getItem('marks')||'[]'); }catch(e){ return []; } }
function saveApps(arr){ localStorage.setItem('apps', JSON.stringify(arr)); }
function saveMarks(arr){ localStorage.setItem('marks', JSON.stringify(arr)); }

/* toast */
function showToast(msg, time=3500){
  const t = q('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=> t.style.display='none', time);
}

/* UI control */
const sections = ['home','apply','slip','result','admin','marksUpload'];
function openSection(id){
  sections.forEach(s => document.getElementById(s).classList.toggle('hidden', s!==id));
  window.scrollTo({top:0,behavior:'smooth'});
}
window.openSection = openSection;
openSection('home');

/* Safe HTML escape */
function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ------------------ Roll generator (fixed) ------------------ */
function getNextRoll(){
  // Start from 801 if unset
  let r = Number(localStorage.getItem('next_roll') || 801);
  const current = String(r);
  localStorage.setItem('next_roll', String(r+1));
  return current;
}

/* ------------------ Fees ------------------ */
function calcAppFee(){
  const cls = q('stu_class').value || '';
  if(cls.startsWith('11') || cls.startsWith('12')) q('app_fee').value = 650;
  else q('app_fee').value = 650;
}
window.calcAppFee = calcAppFee;
calcAppFee();

/* ------------------ Render saved applications list ------------------ */
function renderAppsList(){
  const apps = readApps();
  const el = q('appsList');
  if(!apps.length){ el.textContent='No applications yet.'; return; }
  el.innerHTML = '';
  apps.slice().reverse().forEach(a=>{
    const d = document.createElement('div');
    d.className = 'result-row';
    d.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
                    <img src="${a.photo||a.feeImage||''}" onerror="this.style.display='none'" style="width:48px;height:48px;border-radius:6px;object-fit:cover"/>
                    <div><strong>${escapeHtml(a.name)} ${escapeHtml(a.surname)}</strong><div class="small">Roll: ${a.roll} â€¢ ${escapeHtml(a.class)} â€¢ Fee: ${a.appFee}</div></div>
                   </div>
                   <div style="display:flex;flex-direction:column;gap:6px">
                     <button class="btn btn-ghost" onclick="quickView('${a.roll}')">View Slip</button>
                     <div class="small">Payment: <strong>${a.paymentStatus}</strong></div>
                   </div>`;
    el.appendChild(d);
  });
}

/* quick view -> jump to slip with roll */
function quickView(roll){
  q('slip_roll').value = roll;
  openSection('slip');
  genSlip();
}

/* ------------------ Apply form submit (uses demo modal) ------------------ */
const applyForm = q('applyForm');
const applyConfirm = q('applyConfirm');

// Reset
function applyFormReset(){
  applyForm.reset();
  calcAppFee();
  applyConfirm.classList.add('hidden');
  applyConfirm.innerHTML = '';
  applyForm.classList.remove('hidden');
}

applyForm.addEventListener('submit', function(e){
  e.preventDefault();

  // basic validations
  const cnic = q('stu_cnic').value.trim();
  if(cnic && cnic.length !== 13){ alert('Student CNIC must be 13 digits'); return; }
  const fcnic = q('father_cnic').value.trim();
  if(fcnic && fcnic.length !== 13){ alert('Father CNIC must be 13 digits'); return; }
  const wa = q('stu_whatsapp').value.trim();
  if(wa && wa.length!==11 && wa.length!==0){ alert('WhatsApp number must be 11 digits (or leave empty)'); return; }

  // payment sender optional in demo; if provided must match pattern
  const paymentSender = q('payment_sender_number').value.trim();
  if(paymentSender && !/^03[0-9]{9}$/.test(paymentSender)){ alert('Payment sender number must be in 03XXXXXXXXX format (or leave empty)'); return; }

  // prepare data to store AFTER payment step
  const roll = getNextRoll();

  // gather form fields (photo & fee screenshot handled later)
  const formSnapshot = {
    roll,
    name: q('stu_name').value.trim(),
    surname: q('stu_surname').value.trim(),
    gender: q('stu_gender').value,
    dob: q('stu_dob').value,
    cnic,
    class: q('stu_class').value,
    pastSchool: q('stu_pastSchool').value.trim(),
    whatsapp: wa,
    photoFile: q('stu_photo').files && q('stu_photo').files[0] ? q('stu_photo').files[0] : null,
    feeFile: q('fee_screenshot').files && q('fee_screenshot').files[0] ? q('fee_screenshot').files[0] : null,
    appFee: q('app_fee').value || 0,
    paymentSenderNumber: paymentSender,
    fatherName: q('father_name').value.trim(),
    fatherSurname: q('father_surname').value.trim(),
    fatherCnic: fcnic,
    fatherOccupation: q('father_occupation').value.trim()
  };

  // open demo payment modal and store snapshot temporarily
  openPaymentModal(formSnapshot);
});

/* ------------------ Demo Payment Modal logic ------------------ */
const paymentModal = q('paymentModal');
let currentSnapshot = null;

function openPaymentModal(snapshot){
  currentSnapshot = snapshot;
  paymentModal.style.display = 'flex';
}
q('closeModalBtn').addEventListener('click', ()=> {
  paymentModal.style.display = 'none';
  currentSnapshot = null;
});

// Simulate JazzCash (auto-approve)
q('simPayBtn').addEventListener('click', ()=> {
  if(!currentSnapshot){ alert('No application in progress'); paymentModal.style.display='none'; return; }
  // simulate a transaction id and approve
  const txId = 'SIMTX' + Date.now();
  // read photo/fee files (if any) and then save
  readFilesAndSave(currentSnapshot, { method: 'simulate', txId, approved: true });
  paymentModal.style.display = 'none';
  currentSnapshot = null;
});

// Choose to upload screenshot (manual verify) - we'll save with Pending status
q('uploadOnlyBtn').addEventListener('click', ()=> {
  if(!currentSnapshot){ alert('No application in progress'); paymentModal.style.display='none'; return; }
  readFilesAndSave(currentSnapshot, { method: 'upload', approved: false });
  paymentModal.style.display = 'none';
  currentSnapshot = null;
});

/* read files (photo & fee) to base64 and save app */
function readFilesAndSave(snapshot, opts){
  // read fee first if exists
  const readerFee = new FileReader();
  const feeFile = snapshot.feeFile;
  const photoFile = snapshot.photoFile;

  function continueSave(feeData){
    if(photoFile){
      const readerPhoto = new FileReader();
      readerPhoto.onload = function(){
        saveApplication(snapshot, feeData, readerPhoto.result, opts);
      };
      readerPhoto.readAsDataURL(photoFile);
    } else {
      saveApplication(snapshot, feeData, '', opts);
    }
  }

  if(feeFile){
    readerFee.onload = function(){ continueSave(readerFee.result); };
    readerFee.readAsDataURL(feeFile);
  } else {
    continueSave('');
  }
}

function saveApplication(snapshot, feeData, photoData, opts){
  const app = {
    roll: snapshot.roll,
    name: snapshot.name,
    surname: snapshot.surname,
    gender: snapshot.gender,
    dob: snapshot.dob,
    cnic: snapshot.cnic,
    class: snapshot.class,
    pastSchool: snapshot.pastSchool,
    whatsapp: snapshot.whatsapp,
    photo: photoData,
    feeImage: feeData,
    paymentStatus: opts.approved ? 'Approved' : 'Pending',
    appFee: snapshot.appFee,
    paymentSenderNumber: snapshot.paymentSenderNumber,
    fatherName: snapshot.fatherName,
    fatherSurname: snapshot.fatherSurname,
    fatherCnic: snapshot.fatherCnic,
    fatherOccupation: snapshot.fatherOccupation,
    txId: opts.txId || ''
  };
  const apps = readApps();
  apps.push(app);
  saveApps(apps);

  // show confirmation UI (if approved show green)
  applyConfirm.classList.remove('hidden');
  applyConfirm.innerHTML = `
    <div class="confirm-box">
      <img src="${escapeHtml(photoData||feeData||'')}" class="stu-photo" onerror="this.style.display='none'"/>
      <div>
        <div style="font-weight:800;color:#0f172a">Application Submitted</div>
        <div style="margin-top:6px"><strong>Roll:</strong> ${app.roll}</div>
        <div><strong>${escapeHtml(app.name)} ${escapeHtml(app.surname)}</strong> â€¢ ${escapeHtml(app.gender)}</div>
        <div class="small">Class: ${escapeHtml(app.class)} â€¢ DOB: ${escapeHtml(app.dob)}</div>
        <div class="small">Fee: ${app.appFee} â€¢ Payment: ${app.paymentStatus}</div>
        <div class="small">Payment Sent From: <strong>${escapeHtml(app.paymentSenderNumber)}</strong></div>
        ${ opts.approved ? `<div class="small" style="margin-top:8px;color:green">Payment auto-verified (Demo). You can generate slip now.</div>` : `<div class="small" style="margin-top:8px;color:orange">Payment pending â€” admin will verify screenshot.</div>`}
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn btn-primary" onclick="copyRoll('${app.roll}')">Copy Roll</button>
          <button class="btn btn-ghost" onclick="openSection('slip'); q('slip_roll').value='${app.roll}'; genSlip()">View Slip</button>
          <button class="btn" onclick="applyFormReset()">Close</button>
        </div>
      </div>
    </div>
  `;
  applyForm.reset();
  applyForm.classList.add('hidden');

  renderAppsList();
  if(!q('adminArea').classList.contains('hidden')) loadAdminData();
  showToast('Application submitted â€” ' + app.paymentStatus.toLowerCase());
}

/* copy roll helper */
function copyRoll(r){
  navigator.clipboard && navigator.clipboard.writeText(r).then(()=> showToast('Roll copied'));
}

/* ------------------ Slip generation (Final Fixed Version) ------------------ */
q('genSlipBtn').addEventListener('click', genSlip);

function genSlip(){
  const roll = q('slip_roll').value.trim();
  if(!roll){ alert('Enter roll number'); return; }

  const apps = readApps();
  const a = apps.find(x=>x.roll === roll);

  if(!a){
    q('slipArea').innerHTML = '<div class="small">Roll not found</div>';
    return;
  }

  if(a.paymentStatus !== 'Approved'){
    q('slipArea').innerHTML = `
      <div class="small" style="color:red;font-size:16px;padding:10px">
        Payment not verified (Status: ${escapeHtml(a.paymentStatus)}). Contact admin.
      </div>`;
    return;
  }

  q('slipArea').innerHTML = `
  <div class="slip-wrapper">

    <div class="slip-header">
      <img src="logo dua Academy kamoon shaheed.PNG" class="academy-logo" onerror="this.style.display='none'">
      <div class="academy-name">Dua Educational Academy Kamoon Shaheed</div>
    </div>

    <div class="slip-card">
      <div class="photo-box">
        <img src="${a.photo || ''}" class="stu-photo" onerror="this.style.display='none'">
      </div>

      <div class="info-area">
        <h2 class="slip-title">Student Admit Slip</h2>

        <div class="row"><strong>Name:</strong> ${escapeHtml(a.name)} ${escapeHtml(a.surname)}</div>
        <div class="row"><strong>Gender:</strong> ${escapeHtml(a.gender)}
          &nbsp; | &nbsp; <strong>DOB:</strong> ${escapeHtml(a.dob)}
        </div>
        <div class="row"><strong>Class:</strong> ${escapeHtml(a.class)}</div>
        <div class="row"><strong>Roll No:</strong> <span class="roll-tag">${escapeHtml(a.roll)}</span></div>
        <div class="row"><strong>Fee:</strong> ${a.appFee}
          &nbsp; | &nbsp; <strong>Payment:</strong> ${escapeHtml(a.paymentStatus)}
        </div>
        <div class="row"><strong>Payment Sent From:</strong> ${escapeHtml(a.paymentSenderNumber || 'N/A')}</div>
        <div class="row"><strong>WhatsApp:</strong> ${escapeHtml(a.whatsapp || 'N/A')}</div>
        <div class="row"><strong>Past School:</strong> ${escapeHtml(a.pastSchool || 'N/A')}</div>

        <h3 class="father-title">Father Information</h3>
        <div class="row">
          <strong>${escapeHtml(a.fatherName)} ${escapeHtml(a.fatherSurname)}</strong>
          &nbsp; | &nbsp; CNIC: ${escapeHtml(a.fatherCnic)}
          &nbsp; | &nbsp; ${escapeHtml(a.fatherOccupation || 'Occupation N/A')}
        </div>
      </div>
    </div>

    <div class="bottom-sign">
      <div class="sign-block">
        <img src="director_sign.png" class="sign-img" onerror="this.style.display='none'">
        <div class="sign-text">Director Signature</div>
      </div>
      <div class="stamp-block">
        <img src="stamp.png" class="stamp-img" onerror="this.style.display='none'">
        <div class="sign-text">Official Stamp</div>
      </div>
    </div>

  </div>`;
}


/* ------------------ PRINT (Fixed â€“ Always One Page) ------------------ */
q('printSlipBtn').addEventListener('click', ()=>{
  if(!q('slipArea').innerHTML){ alert('No slip to print'); return; }

  const win = window.open('', '_blank');

  const styles = `
  <style>
    body{font-family:Arial, sans-serif;margin:0;padding:0}

    .slip-wrapper{
      border:4px solid #0057d9;
      background:white;
      padding:25px;
      border-radius:18px;
      width:780px;
      margin:auto;
    }

    .slip-header{
      display:flex;align-items:center;gap:15px;
      border-bottom:3px solid #0057d9;padding-bottom:10px;margin-bottom:20px;
    }

    .academy-logo{width:70px;height:70px;border-radius:50%}
    .academy-name{font-size:26px;font-weight:900;color:#003b99}

    .slip-card{
      display:flex;gap:20px;background:#e9f1ff;
      padding:20px;border-radius:15px;border:2px solid #004fc3;
    }

    .photo-box{
      width:120px;height:140px;border:2px solid #004fc3;
      border-radius:10px;background:white;overflow:hidden;
    }

    .stu-photo{width:100%;height:100%;object-fit:cover}

    .slip-title{font-size:22px;font-weight:800;color:#003b99;margin-bottom:10px}
    .row{padding:4px 0;font-size:15px}

    .roll-tag{background:#004fc3;color:white;padding:3px 8px;border-radius:5px}

    .bottom-sign{
      display:flex;justify-content:space-between;
      margin-top:25px;padding-top:15px;border-top:3px solid #0057d9;
    }

    .sign-img,.stamp-img{width:120px;height:auto}

    @page { size:A4 portrait; margin:0; }

    @media print {
      body { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      .slip-wrapper{
        width:780px !important;
        transform:scale(0.96);
        transform-origin:top left;
        page-break-inside:avoid;
      }
    }
  </style>`;

  win.document.write(`<html><head><title>Admit Slip</title>${styles}</head><body>${q('slipArea').innerHTML}</body></html>`);
  win.document.close();
  win.focus();
  win.print();
});

/* ------------------ RESULTS (Final Fixed Version) ------------------ */
q('checkResBtn').addEventListener('click', function () {
  const roll = q('res_roll').value.trim();

  if (!roll) {
    alert('Enter roll number');
    return;
  }

  const apps = readApps();
  const a = apps.find(x => x.roll === roll);

  if (!a) {
    q('resultArea').innerHTML = '<div class="small">Roll not found</div>';
    return;
  }

  const marks = readMarks()
    .filter(m => m.rollNumber === roll)
    .map(m => m.marks);

  const grade = marks.length ? calculateGrade(avg(marks)) : 'N/A';

  q('resultArea').innerHTML = `
  <div class="result-wrapper">

    <div class="res-header">
      <img src="logo dua Academy kamoon shaheed.PNG" class="res-logo" onerror="this.style.display='none'">
      <div class="res-title">Dua Educational Academy Kamoon Shaheed</div>
    </div>

    <div class="res-card">

      <div class="res-photo-box">
        <img src="${a.photo || ''}" class="res-photo" onerror="this.style.display='none'">
      </div>

      <div class="res-info">
        <h2 class="res-heading">Student Result Card</h2>

        <div class="line"><strong>Name:</strong> ${escapeHtml(a.name)} ${escapeHtml(a.surname)}</div>
        <div class="line"><strong>Class:</strong> ${escapeHtml(a.class)}</div>
        <div class="line"><strong>Roll No:</strong> <span class="roll-tag">${escapeHtml(a.roll)}</span></div>
        <div class="line"><strong>WhatsApp:</strong> ${escapeHtml(a.whatsapp || 'N/A')}</div>

        <h3 class="sub-heading">Marks Details</h3>
        <div class="line"><strong>Marks:</strong> ${marks.length ? marks.join(', ') : 'Not uploaded'}</div>
        <div class="line"><strong>Grade:</strong> ${grade}</div>

        <h3 class="sub-heading">Father Information</h3>
        <div class="line"><strong>${escapeHtml(a.fatherName)} ${escapeHtml(a.fatherSurname)}</strong></div>
        <div class="line"><strong>CNIC:</strong> ${escapeHtml(a.fatherCnic)}</div>
      </div>
    </div>

    <div class="res-bottom">
      <div class="sign-box">
        <img src="director_sign.png" class="sign-img" onerror="this.style.display='none'">
        <div class="sign-text">Director Signature</div>
      </div>

      <div class="stamp-box">
        <img src="stamp.png" class="stamp-img" onerror="this.style.display='none'">
        <div class="sign-text">Official Stamp</div>
      </div>
    </div>

  </div>`;
});


/* ------------------ PRINT RESULT (Single Page Perfect PDF) ------------------ */

q('printResultBtn').addEventListener('click', () => {
  if (!q('resultArea').innerHTML) {
    alert('No result to print');
    return;
  }

  const win = window.open('', '_blank');

  const styles = `
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }

    .result-wrapper {
      border: 4px solid #0057d9;
      background: white;
      padding: 25px;
      border-radius: 18px;
      width: 780px;
      margin: auto;
    }

    .res-header {
      display: flex; align-items: center; gap: 15px;
      border-bottom: 3px solid #0057d9;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .res-logo { width: 70px; height: 70px; border-radius: 50%; }
    .res-title { font-size: 26px; font-weight: 900; color: #003b99; }

    .res-card {
      display: flex; gap: 20px;
      background: #e9f1ff;
      padding: 20px;
      border-radius: 15px;
      border: 2px solid #004fc3;
    }

    .res-photo-box {
      width: 120px; height: 140px;
      border: 2px solid #004fc3;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    .res-photo { width: 100%; height: 100%; object-fit: cover; }

    .res-heading { font-size: 22px; font-weight: 800; color: #003b99; margin-bottom: 10px; }
    .line { padding: 4px 0; font-size: 15px; }

    .sub-heading { font-size: 17px; font-weight: 700; margin: 10px 0 5px; color: #003b99; }

    .roll-tag {
      background: #004fc3;
      color: white;
      padding: 3px 8px;
      border-radius: 5px;
    }

    .res-bottom {
      display: flex; justify-content: space-between;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 3px solid #0057d9;
    }

    .sign-img, .stamp-img {
      width: 120px; height: auto;
    }

    @page { size: A4 portrait; margin: 0; }

    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      .result-wrapper {
        width: 780px !important;
        transform: scale(0.96);
        transform-origin: top left;
        page-break-inside: avoid !important;
      }
    }
  </style>`;

  win.document.write(`
    <html><head><title>Result Card</title>${styles}</head>
    <body>${q('resultArea').innerHTML}</body></html>
  `);

  win.document.close();
  win.focus();
  win.print();
});


/* ------------------ Grade Helpers ------------------ */
function calculateGrade(mark) {
  mark = Number(mark);
  if (mark >= 95) return 'A+';
  if (mark >= 85) return 'A';
  if (mark >= 75) return 'A-';
  if (mark >= 65) return 'B+';
  if (mark >= 60) return 'B';
  if (mark >= 55) return 'C';
  if (mark >= 50) return 'D';
  return 'Fail';
}

function avg(arr) {
  return (arr.reduce((s, n) => s + Number(n), 0) / arr.length).toFixed(2);
}

/* ------------------ Admin table ------------------ */
const adminLoginForm = q('adminLoginForm');
const adminArea = q('adminArea');
const adminTableBody = document.querySelector('#adminTable tbody');

adminLoginForm.addEventListener('submit', function(e){
  e.preventDefault();
  const val = q('adminPass').value;
  if(val === ADMIN_PASSWORD){
    adminLoginForm.classList.add('hidden');
    adminArea.classList.remove('hidden');
    loadAdminData();
  } else alert('Wrong Password');
});

function loadAdminData(){
  const apps = readApps();
  const marks = readMarks();
  adminTableBody.innerHTML = '';
  apps.forEach(a=>{
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td>${escapeHtml(a.roll)}</td>
      <td><img src="${a.photo||''}" class="admin-img" onerror="this.style.display='none'"/></td>
      <td contenteditable="true" data-field="name">${escapeHtml(a.name)}</td>
      <td contenteditable="true" data-field="surname">${escapeHtml(a.surname)}</td>
      <td contenteditable="true" data-field="gender">${escapeHtml(a.gender)}</td>
      <td contenteditable="true" data-field="dob">${escapeHtml(a.dob)}</td>
      <td contenteditable="true" data-field="cnic">${escapeHtml(a.cnic)}</td>
      <td contenteditable="true" data-field="class">${escapeHtml(a.class)}</td>
      <td contenteditable="true" data-field="pastSchool">${escapeHtml(a.pastSchool)}</td>
      <td contenteditable="true" data-field="whatsapp">${escapeHtml(a.whatsapp)}</td>
      <td contenteditable="true" data-field="fatherName">${escapeHtml(a.fatherName)}</td>
      <td contenteditable="true" data-field="fatherSurname">${escapeHtml(a.fatherSurname)}</td>
      <td contenteditable="true" data-field="fatherCnic">${escapeHtml(a.fatherCnic)}</td>
      <td contenteditable="true" data-field="fatherOccupation">${escapeHtml(a.fatherOccupation)}</td>
      <td>${escapeHtml(a.appFee || '')}</td>
      <td>${escapeHtml(a.paymentSenderNumber || '')}</td>
      <td>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-start">
          <img src="${a.feeImage||''}" style="width:70px;height:70px;border-radius:6px;object-fit:cover" onerror="this.style.display='none'"/>
          <div> <strong>${escapeHtml(a.paymentStatus)}</strong> </div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-primary btn-approve">Approve</button>
            <button class="btn btn-ghost btn-reject">Reject</button>
          </div>
        </div>
      </td>
      <td contenteditable="true" data-field="marks">${marks.filter(m=>m.rollNumber===a.roll).map(m=>m.marks).join(', ')}</td>
      <td><button class="btn btn-primary btn-save">Save</button> <button class="btn btn-ghost btn-delete">Delete</button></td>
    `;
    adminTableBody.appendChild(tr);

    tr.querySelector('.btn-approve').addEventListener('click', ()=> setPaymentStatus(a.roll, 'Approved'));
    tr.querySelector('.btn-reject').addEventListener('click', ()=> setPaymentStatus(a.roll, 'Rejected'));

    tr.querySelector('.btn-delete').addEventListener('click', ()=> {
      if(!confirm('Delete this application?')) return;
      let appsAll = readApps();
      appsAll = appsAll.filter(x=>x.roll!==a.roll);
      saveApps(appsAll);
      let marksAll = readMarks();
      marksAll = marksAll.filter(m=>m.rollNumber!==a.roll);
      saveMarks(marksAll);
      loadAdminData();
      renderAppsList();
    });

    tr.querySelector('.btn-save').addEventListener('click', ()=> applyAdminEdits(tr, a.roll) );

    tr.querySelectorAll('td[contenteditable]').forEach(td=>{
      td.addEventListener('blur', ()=> applyAdminEdits(tr, a.roll) );
    });
  });
}

/* set payment and (simulated) notify */
function setPaymentStatus(roll, status){
  let appsAll = readApps();
  const idx = appsAll.findIndex(x=>x.roll===roll);
  if(idx === -1) return;
  appsAll[idx].paymentStatus = status;

  saveApps(appsAll);
  loadAdminData();
  renderAppsList();

  const student = appsAll[idx];

  if(status === 'Approved'){
    const msg = `${ACADEMY_NAME}\n\nDear ${student.name},\nYour entry test form has been approved.\nRoll No: ${student.roll}\nStudent: ${student.name} ${student.surname}\nFather: ${student.fatherName} ${student.fatherSurname}\nPayment From: ${student.paymentSenderNumber || 'N/A'}`;
    alert(`To Student (${student.whatsapp || 'no number'}):\n\n${msg}`);
    alert(`To Father (number saved in record):\n\n${msg}`);
    showToast('Payment approved â€” notifications sent (simulated)');
  } else {
    const msg = `${ACADEMY_NAME}\n\nDear ${student.name},\nYour payment has been rejected. Please contact the academy.`;
    alert(msg);
    showToast('Payment rejected â€” student notified (simulated)');
  }
}

/* apply admin edits */
function applyAdminEdits(tr, roll){
  const appsAll = readApps();
  const idx = appsAll.findIndex(x=>x.roll===roll);
  if(idx === -1) { alert('Application not found'); return; }

  const cells = tr.querySelectorAll('td[contenteditable]');
  const app = appsAll[idx];

  cells.forEach(td=>{
    const field = td.getAttribute('data-field');
    const text = td.textContent.trim();
    if(field === 'marks'){
      const arr = text.split(',').map(s=>s.trim()).filter(s=>s!=='').map(Number).filter(n=>!isNaN(n));
      let marksAll = readMarks();
      marksAll = marksAll.filter(m=>m.rollNumber!==roll);
      arr.forEach(v => marksAll.push({ rollNumber: roll, marks: Number(v) }));
      saveMarks(marksAll);
    } else {
      app[field] = text;
    }
  });

  appsAll[idx] = app;
  saveApps(appsAll);
  loadAdminData();
  renderAppsList();
}

/* ------------------ Marks upload (password protected) ------------------ */
q('marksForm').addEventListener('submit', function(e){
  e.preventDefault();
  if(q('marksPass').value !== ADMIN_PASSWORD){ alert('Wrong Password'); return; }
  q('marksArea').classList.remove('hidden');
  q('marksForm').classList.add('hidden');
});

q('saveMarksBtn').addEventListener('click', function(){
  const roll = q('marks_roll').value.trim();
  const val = q('marks_value').value;
  if(!roll || val==='') { alert('Enter roll and marks'); return; }
  const apps = readApps();
  if(!apps.find(x=>x.roll===roll)){ alert('Roll not found'); return; }
  const marksAll = readMarks();
  marksAll.push({ rollNumber: roll, marks: Number(val) });
  saveMarks(marksAll);

  const student = apps.find(x=>x.roll===roll);
  if(student){
    const msg = `${ACADEMY_NAME}\n\nDear ${student.name},\nYour test result has been uploaded.\nRoll No: ${student.roll}\nMarks: ${val}`;
    alert(`To Student (${student.whatsapp || 'no number'}):\n\n${msg}`);
    alert(`To Father:\n\n${msg}`);
    showToast('Result uploaded â€” notifications sent (simulated)');
  }

  alert('Marks uploaded');
  if(!q('adminArea').classList.contains('hidden')) loadAdminData();
});

/* ------------------ Init ------------------ */
renderAppsList();
loadAdminData();

</script>
</body>
</html>
